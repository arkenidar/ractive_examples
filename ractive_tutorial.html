<!doctype html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>to-do list</title>
<link rel="manifest" href="todo_app_manifest.json">

<div id="target"></div>

<script id="template" type="text/ractive">
  <h3>to-do list</h3>
  <button onclick="toggle_edit_mode()">toggle edit-mode</button>
  {{#if edit_mode==true}}
    <ul>
      {{#each todos: index}}
      <li>
        {{#if editing!=index}}
          {{#if reorder_mode}}
            <button onclick="up({{index}})">up</button>
            <button onclick="down({{index}})">down</button>
            {{this}}
          {{else}}
            <button onclick="edit({{index}})">{{this}}</button>
          {{/if}}
        {{else}}
          <form onsubmit="save({{index}}); return false;">
          
          <input value="{{item_edit}}" id="item_edit" autocomplete="off" placeholder="item">
          </form>
        {{/if}}
        </li>
      {{/each}}
      {{#if editing==-1 && reorder_mode==false}}
        <li>
          <form onsubmit="add(); return false;">
            <input value='{{item}}' id="item_add" autocomplete="off" placeholder="add item">
          </form>
        </li>
      {{/if}}
    </ul>
    {{#if todos.length>1}}
      <button onclick="toggle_reorder_mode()">toggle reorder-mode</button>
    {{/if}}
  {{else}}
    <ul>
      {{#each todos}}
        <li>{{this}}</li>
      {{/each}}
    </ul>
  {{/if}}

</script>

<script src="https://cdn.jsdelivr.net/npm/ractive"></script>

<script>

var ractive = new Ractive({

  target: '#target',

  template: '#template',

  data: {

    todos: localStorage.todos ? JSON.parse(localStorage.todos) : [],

    editing: -1,
    edit_mode: true,
    reorder_mode: false,
  },

})

function add(){
  var item = ractive.get('item')
  if(item.trim()=='') return
  var todos = ractive.get('todos')
  todos.push(item)
  ractive.set('todos', todos)
  localStorage.todos = JSON.stringify(todos)
  ractive.set('item', '')
}

function remove(item){
  ractive.set('editing', -1)
  var todos = ractive.get('todos')
  todos.splice(item, 1)
  ractive.set('todos', todos)
  localStorage.todos = JSON.stringify(todos)
}

function edit(index){
  ractive.set('item_edit', ractive.get('todos')[index])
  ractive.set('editing', index)
  document.querySelector('#item_edit').focus()
}

function save(index){
  ractive.set('editing', -1)
  var item_edit = ractive.get('item_edit')
  if(item_edit.trim()==''){
    remove(index)
    return
  }
  var todos = ractive.get('todos')
  todos[index] = item_edit
  ractive.set('todos', todos)
  localStorage.todos = JSON.stringify(todos)
}

function swap(array, index_a, index_b){
  var temp = array[index_a]
  array[index_a] = array[index_b]
  array[index_b] = temp
  return array
}

function up(index){
  var todos = ractive.get('todos')
  if(index<=0) return
  todos = swap(todos, index, index-1)
  ractive.set('todos', todos)
  localStorage.todos = JSON.stringify(todos)
}

function down(index){
  var todos = ractive.get('todos')
  if(index>=(todos.length-1)) return
  todos = swap(todos, index, index+1)
  ractive.set('todos', todos)
  localStorage.todos = JSON.stringify(todos)
}

function toggle_edit_mode(){
  ractive.set('reorder_mode', false)
  ractive.set('edit_mode', !ractive.get('edit_mode'))
}

function toggle_reorder_mode(){
  ractive.set('reorder_mode', !ractive.get('reorder_mode'))
}

</script>
